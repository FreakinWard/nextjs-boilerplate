# Node.js Express Web App to Linux on Azure
# Build a Node.js Express app and deploy it to Azure as a Linux web app.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - main

parameters:
  - name: pullRequest
    type: boolean
    default: false

variables:
  azureSubscription: '6001685e-2c0d-4d57-b07f-e198dfce3799'
  npm_config_cache: $(Pipeline.Workspace)/.npm
  CYPRESS_CACHE_FOLDER: $(Pipeline.Workspace)/.cache/Cypress

stages:
  - stage: stageBuild
    displayName: Build
    jobs:
      - template: templates/build.yml


  - stage: stageDeployDev
    displayName: Dev
    dependsOn: stageBuild
    condition: and(succeeded(), eq(${{ parameters.pullRequest }}, true))
    jobs:
      - template: templates/deploy.yml
        parameters:
          appName: app-nextjs-boilerplate
          environmentType: Dev
          regions:
            - East
            - West


  - stage: stageDeployIntegration
    displayName: Integration
    dependsOn: stageBuild
    condition: and(succeeded(), eq(${{ parameters.pullRequest }}, false))
    jobs:
      - template: templates/deploy.yml
        parameters:
          environmentType: QA
          appName: app-nextjs-boilerplate-qa


  - stage: stageDeployQA
    displayName: QA
    dependsOn: stageDeployIntegration
    jobs:
      - template: templates/swapSlot.yml
        parameters:
          environmentType: QA
          appName: app-nextjs-boilerplate-qa
          resourceGroupName: nextjs-boilerplate
          requireManual: true


  - stage: stageDeployStaging
    displayName: Staging Prod
    dependsOn: stageDeployQA
#    condition: eq(true, false) # TODO: disabled until production environment is created
    jobs:
      - template: templates/deploy.yml
        parameters:
          environmentType: ProdStaging
          appName: app-nextjs-boilerplate-prod
          slotName: staging
          requireManual: true


  - stage: stageDeployProd
    displayName: Prod
    dependsOn: stageDeployStaging
    jobs:
      - template: templates/swapSlot.yml
        parameters:
          environmentType: Prod
          appName: app-nextjs-boilerplate-prod
          resourceGroupName: nextjs-boilerplate
          requireManual: true
