parameters:
  - name: appUrl
    type: string

steps:
- task: PowerShell@2
  displayName: 'Smoke Test'
  timeoutInMinutes: 5
  env:
    ciBuildNumber: $(ciBuildNumber)
    appUrl: ${{ parameters.appUrl }}/api/health
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ping: " $env:appUrl -ForegroundColor Green
      
      Do {
        try {
          $response = Invoke-RestMethod -Uri $env:appUrl -TimeoutSec 5
          Write-Host "Expected:" $env:ciBuildNumber -> Received: $response.buildNumber
        } catch { Write-Host "No Response" -ForegroundColor Yellow }
        Start-Sleep -Seconds 2
      }
      while (-not $response -or $response.buildNumber -ne $env:ciBuildNumber)
      Write-Host "App deployed, hooray! ðŸš€" -ForegroundColor Green
    pwsh: true
