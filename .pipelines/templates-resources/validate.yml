parameters:
  - name: environmentTypes
    type: object
    values:
      - Dev
      - QA
      - Prod

  - name: regions
    type: object
    default:
      - East

  - name: serviceConnection
    type: string

jobs:
  - ${{ each environmentType in parameters.environmentTypes }}:
      - ${{ each region in parameters.regions }}:
          - job: validateBicepCode_${{ environmentType }}_${{ region }}
            displayName: Validate ${{ environmentType }} - ${{ region }}
            variables:
              regionName: ${{ lower(region) }}
              environmentName: ${{ lower(environmentType) }}
              rgName: $(resourceGroupPrefix)-$(appName)-${{ parameters.environmentName }}-${{ parameters.regionName }}
            steps:
              - template: azDeploy.yml
                parameters:
                  action: validate
                  environmentName: $(environmentName)
                  regionName: $(regionName)
                  serviceConnection: ${{ parameters.serviceConnection }}
                  rgName: $(rgName)
#              - task: AzureCLI@2
#                name:
#                displayName: Validation - ${{ region }}
#                inputs:
#                  azureSubscription: ${{ parameters.serviceConnection }}
#                  scriptType: bash
#                  scriptLocation: inlineScript
#                  inlineScript: |
#                    az deployment group validate \
#                      --resource-group $(resourceGroupPrefix)-$(appName)-$(environmentName)-$(regionName) \
#                      --template-file .pipelines/templates-resources/main.bicep \
#                      --parameters appName=$(appName) environmentType=$(environmentName) region=$(regionName)
